import {
  Lucid,
  Blockfrost,
  Constr,
  Data,
} from "https://unpkg.com/lucid-cardano@0.10.11/web/mod.js";

/* =====================================================
   CONFIG
===================================================== */

const BLOCKFROST_URL =
  "https://cardano-preprod.blockfrost.io/api/v0";
const BLOCKFROST_KEY =
  "preprodYjRkHfcazNkL0xxG9C2RdUbUoTrG7wip";
const NETWORK = "Preprod";

/* =====================================================
   PLUTUS SCRIPT (PASTE YOUR CBOR HEX)
===================================================== */

const SCRIPT_CBOR = "590cbc0100003232323232332232323232323232323322323233223232323232323232323322323232323232322323232323232232232325335323232325333500315335533533012500135004222222006103213357389201186661726d6572207369676e6174757265206d697373696e67000311533553353500422222200310321335738921197261696e66616c6c20636f6e646974696f6e206661696c65640003115335533535004222222002103213357389212163726f7020706c616e74696e6720766572696669636174696f6e206661696c65640003115335533535004222222001103213357389211d636f6d6d756e697479206174746573746174696f6e206d697373696e670003115335333573466e20ccc044ccd54c05c4800540554090cc04cd40108888880194004050050d40108888880100c40c840c84cd5ce249196661726d6572206e6f74207061696420636f72726563746c79000311031103110311031153355335330125001350042222220051032133573892011c676f7665726e6d656e74207369676e6174757265206d697373696e670003115335333573466e20ccc044ccd54c05c4800540554090cc04cd40108888880154004050050d40108888880100c40c840c84cd5ce2492a676f7665726e6d656e7420646964206e6f742072656365697665207265636c61696d65642066756e647300031103115335330125001350042222220051032133573892011c676f7665726e6d656e74207369676e6174757265206d697373696e6700031135001220023333573466e1cd55cea80224000466442466002006004646464646464646464646464646666ae68cdc39aab9d500c480008cccccccccccc88888888888848cccccccccccc00403403002c02802402001c01801401000c008cd40ac0b0d5d0a80619a8158161aba1500b33502b02d35742a014666aa05eeb940b8d5d0a804999aa817bae502e35742a01066a0560726ae85401cccd540bc0e9d69aba150063232323333573466e1cd55cea801240004664424660020060046464646666ae68cdc39aab9d5002480008cc8848cc00400c008cd4111d69aba150023045357426ae8940088c98c8124cd5ce02482502389aab9e5001137540026ae854008c8c8c8cccd5cd19b8735573aa004900011991091980080180119a8223ad35742a004608a6ae84d5d1280111931902499ab9c04904a047135573ca00226ea8004d5d09aba2500223263204533573808a08c08626aae7940044dd50009aba1500533502b75c6ae854010ccd540bc0d88004d5d0a801999aa817bae200135742a00460706ae84d5d1280111931902099ab9c04104203f135744a00226ae8940044d5d1280089aba25001135744a00226ae8940044d5d1280089aba25001135744a00226ae8940044d55cf280089baa00135742a00860506ae84d5d1280211931901999ab9c0330340313333573466e1d401520042122200123333573466e1d401920022122200223333573466e1d401d20002122200323263203433573806806a0640620606666ae68cdc39aab9d500b480008cccccc88888848cccccc00401c01801401000c008dd71aba1500b375c6ae854028dd69aba15009302d35742a010605a6ae85401cc0b4d5d09aba2500723263203133573806206405e20622c26aae7940044dd500089aab9d375400226ae8940044d5d1280089aba25001135744a00226aae7940044dd500091119191800802990009aa8151119a800a4000446a00444a66a666ae68cdc78010048158150980380089803001990009aa8149119a800a4000446a00444a66a666ae68cdc7801003815014880089803001911a801111111111111299a999aa980b8900099a80c11299a801108018800a8119299a999ab9a3371e01c00205e05c26a04a0022a0480084205e205a446a002444444444444666aa602424002446a00444446a0084466a0044a66a666ae68cdc780b80081b01a899a81380300408041004280f80524410012233553007120012350012233550150023355300a12001235001223355018002333500123302a4800000488cc0ac0080048cc0a800520000013355300712001235001223355015002333500123355300b1200123500122335501900235500d0010012233355500800f00200123355300b1200123500122335501900235500c00100133355500300a002001111222333553004120015010335530071200123500122335501500235500900133355300412001223500222533533355300c120013233500e223335003220020020013500122001123300122533500210261001023235001223300a002005006100313350140040035011001335530071200123500122323355016003300100532001355027225335001135500a003221350022253353300c002008112223300200a0041300600300232001355020221122253350011002221330050023335530071200100500400111212223003004112122230010043200135501d22112253350011500e22133500f300400233553006120010040013200135501c2211222533500113500322001221333500522002300400233355300712001005004001122123300100300222333573466e3c00800405c05848c88c008dd6000990009aa80d111999aab9f0012500a233500930043574200460066ae880080688c8c8cccd5cd19b8735573aa004900011991091980080180118079aba150023005357426ae8940088c98c8064cd5ce00c80d00b89aab9e5001137540024646464646666ae68cdc39aab9d5004480008cccc888848cccc00401401000c008c8c8c8cccd5cd19b8735573aa0049000119910919800801801180c1aba15002335010017357426ae8940088c98c8078cd5ce00f00f80e09aab9e5001137540026ae854010ccd54021d728039aba150033232323333573466e1d4005200423212223002004357426aae79400c8cccd5cd19b875002480088c84888c004010dd71aba135573ca00846666ae68cdc3a801a400042444006464c6404066ae700800840780740704d55cea80089baa00135742a00466a018eb8d5d09aba2500223263201a33573803403603026ae8940044d5d1280089aab9e500113754002266aa002eb9d6889119118011bab00132001355017223233335573e0044a010466a00e66aa012600c6aae754008c014d55cf280118021aba20030181357420022244004244244660020080062244246600200600424464646666ae68cdc3a800a400046a00e600a6ae84d55cf280191999ab9a3370ea00490011280391931900a19ab9c014015012011135573aa00226ea800448488c00800c44880048c8c8cccd5cd19b875001480188c848888c010014c01cd5d09aab9e500323333573466e1d400920042321222230020053009357426aae7940108cccd5cd19b875003480088c848888c004014c01cd5d09aab9e500523333573466e1d40112000232122223003005375c6ae84d55cf280311931900919ab9c01201301000f00e00d135573aa00226ea80048c8c8cccd5cd19b8735573aa004900011991091980080180118029aba15002375a6ae84d5d1280111931900719ab9c00e00f00c135573ca00226ea80048c8cccd5cd19b8735573aa002900011bae357426aae7940088c98c8030cd5ce00600680509baa001232323232323333573466e1d4005200c21222222200323333573466e1d4009200a21222222200423333573466e1d400d2008233221222222233001009008375c6ae854014dd69aba135744a00a46666ae68cdc3a8022400c4664424444444660040120106eb8d5d0a8039bae357426ae89401c8cccd5cd19b875005480108cc8848888888cc018024020c030d5d0a8049bae357426ae8940248cccd5cd19b875006480088c848888888c01c020c034d5d09aab9e500b23333573466e1d401d2000232122222223005008300e357426aae7940308c98c8054cd5ce00a80b00980900880800780700689aab9d5004135573ca00626aae7940084d55cf280089baa0012323232323333573466e1d400520022333222122333001005004003375a6ae854010dd69aba15003375a6ae84d5d1280191999ab9a3370ea0049000119091180100198041aba135573ca00c464c6401c66ae7003803c03002c4d55cea80189aba25001135573ca00226ea80048c8c8cccd5cd19b875001480088c8488c00400cdd71aba135573ca00646666ae68cdc3a8012400046424460040066eb8d5d09aab9e500423263200b33573801601801201026aae7540044dd500089119191999ab9a3370ea00290021091100091999ab9a3370ea00490011190911180180218031aba135573ca00846666ae68cdc3a801a400042444004464c6401866ae700300340280240204d55cea80089baa0012323333573466e1d40052002200523333573466e1d40092000200523263200833573801001200c00a26aae74dd5000891001091000a4c92010350543100120012233700004002224646002002446600660040040021";

const script = {
  type: "PlutusV2",
  script: SCRIPT_CBOR,
};

/* =====================================================
   DATUM / REDEEMER SCHEMA
===================================================== */

const SubsidyDatum = Data.Object({
  sdFarmerPKH: Data.Bytes(),
  sdGovPKH: Data.Bytes(),
  sdRequiredAmount: Data.Integer(),
  sdRainOK: Data.Boolean(),
  sdCropOK: Data.Boolean(),
  sdCommunityOK: Data.Boolean(),
});

const ClaimSubsidyRedeemer = Data.to(new Constr(0, []));
const ReportFraudRedeemer = Data.to(new Constr(1, []));
const UpdateDataRedeemer  = Data.to(new Constr(2, []));

/* =====================================================
   GLOBAL STATE
===================================================== */

let lucid;
let walletAddress;
let walletPKH;
let scriptAddress;

/* =====================================================
   INIT
===================================================== */

async function init() {
  lucid = await Lucid.new(
    new Blockfrost(BLOCKFROST_URL, BLOCKFROST_KEY),
    NETWORK
  );

  const api = await window.cardano.lace.enable();
  lucid.selectWallet(api);

  walletAddress = await lucid.wallet.address();
  walletPKH =
    lucid.utils.getAddressDetails(walletAddress)
      .paymentCredential.hash;

  scriptAddress = lucid.utils.validatorToAddress(script);

  log("Wallet connected");
  log("Script address: " + scriptAddress);
}

/* =====================================================
   BUILD DATUM
===================================================== */

function mkSubsidyDatum(
  farmerPKH,
  govPKH,
  amount,
  rain,
  crop,
  community
) {
  return Data.to(
    {
      sdFarmerPKH: farmerPKH,
      sdGovPKH: govPKH,
      sdRequiredAmount: BigInt(amount),
      sdRainOK: rain,
      sdCropOK: crop,
      sdCommunityOK: community,
    },
    SubsidyDatum
  );
}

/* =====================================================
   LOCK SUBSIDY (GOVERNMENT)
===================================================== */

async function lockSubsidy() {
  const farmerAddr = document.getElementById("farmer").value;
  const amountAda =
    BigInt(document.getElementById("amount").value) * 1_000_000n;

  const farmerPKH =
    lucid.utils.getAddressDetails(farmerAddr)
      .paymentCredential.hash;

  const datum = mkSubsidyDatum(
    farmerPKH,
    walletPKH,
    amountAda,
    true,
    true,
    true
  );

  const tx = await lucid
    .newTx()
    .payToContract(
      scriptAddress,
      { inline: datum },
      { lovelace: amountAda }
    )
    .addSignerKey(walletPKH)
    .complete();

  const signed = await tx.sign().complete();
  const txHash = await signed.submit();

  log("Subsidy locked: " + txHash);
}

/* =====================================================
   CLAIM SUBSIDY (FARMER)
===================================================== */

async function claimSubsidy() {
  const utxos = await lucid.utxosAt(scriptAddress);

  const myUtxo = utxos.find((u) => {
    if (!u.datum) return false;
    const d = Data.from(u.datum, SubsidyDatum);
    return d.sdFarmerPKH === walletPKH;
  });

  if (!myUtxo) {
    return log("No subsidy found");
  }

  const d = Data.from(myUtxo.datum, SubsidyDatum);

  const tx = await lucid
    .newTx()
    .collectFrom([myUtxo], ClaimSubsidyRedeemer)
    .attachSpendingValidator(script)
    .payToAddress(walletAddress, {
      lovelace: d.sdRequiredAmount,
    })
    .addSignerKey(walletPKH)
    .complete();

  const signed = await tx.sign().complete();
  const txHash = await signed.submit();

  log("Subsidy claimed: " + txHash);
}

/* =====================================================
   REPORT FRAUD (GOVERNMENT)
===================================================== */

async function reportFraud() {
  const utxos = await lucid.utxosAt(scriptAddress);

  if (utxos.length === 0) {
    return log("No UTxO found");
  }

  const tx = await lucid
    .newTx()
    .collectFrom(utxos, ReportFraudRedeemer)
    .attachSpendingValidator(script)
    .payToAddress(walletAddress, utxos[0].assets)
    .addSignerKey(walletPKH)
    .complete();

  const signed = await tx.sign().complete();
  const txHash = await signed.submit();

  log("Fraud reported: " + txHash);
}

/* =====================================================
   UI
===================================================== */

function log(msg) {
  document.getElementById("log").innerText = msg;
}


document.getElementById("connect").onclick = init;
document.getElementById("lockSubsidy").onclick = lockSubsidy;
document.getElementById("claimSubsidy").onclick = claimSubsidy;
document.getElementById("reportFraud").onclick = reportFraud;
